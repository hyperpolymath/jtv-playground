<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #login-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 350px;
        }

        #login-container h1 {
            color: #667eea;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        #login-container input, #login-container select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            font-size: 1rem;
        }

        #login-container button {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        #login-container button:hover {
            background: #5568d3;
        }

        #chat-container {
            display: none;
            background: white;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        #chat-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e1e8ed;
            padding: 1rem;
            overflow-y: auto;
        }

        #sidebar h3 {
            margin-bottom: 0.5rem;
            color: #667eea;
        }

        .user-item, .room-item {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover, .room-item:hover {
            background: #e1e8ed;
        }

        .room-item.active {
            background: #667eea;
            color: white;
        }

        #messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 70%;
        }

        .message.system {
            background: #e1e8ed;
            text-align: center;
            max-width: 100%;
            font-style: italic;
            color: #666;
        }

        .message.user {
            background: white;
            border: 1px solid #e1e8ed;
        }

        .message.own {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message .username {
            font-weight: bold;
            margin-bottom: 0.25rem;
            color: #667eea;
        }

        .message.own .username {
            color: white;
        }

        .message .timestamp {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }

        .message.own .timestamp {
            color: rgba(255,255,255,0.7);
        }

        #input-container {
            padding: 1rem;
            border-top: 1px solid #e1e8ed;
            display: flex;
            gap: 0.5rem;
        }

        #message-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            font-size: 1rem;
        }

        #send-button {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #send-button:hover {
            background: #5568d3;
        }

        #typing-indicator {
            padding: 0.5rem 1rem;
            font-style: italic;
            color: #666;
            min-height: 2rem;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>ðŸ’¬ Chat Demo</h1>
        <input type="text" id="username-input" placeholder="Enter your username" />
        <select id="room-select">
            <option value="general">General</option>
            <option value="random">Random</option>
            <option value="tech">Tech</option>
            <option value="gaming">Gaming</option>
        </select>
        <button id="join-button">Join Chat</button>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <h2 id="room-name">General</h2>
            <div id="user-count">0 users</div>
        </div>
        <div id="chat-body">
            <div id="sidebar">
                <h3>Rooms</h3>
                <div id="rooms-list"></div>
                <h3 style="margin-top: 1rem;">Users</h3>
                <div id="users-list"></div>
            </div>
            <div id="messages-container">
                <div id="messages"></div>
                <div id="typing-indicator"></div>
                <div id="input-container">
                    <input type="text" id="message-input" placeholder="Type a message..." />
                    <button id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let currentRoom = 'general';
        let typingTimeout = null;

        // DOM elements
        const loginContainer = document.getElementById('login-container');
        const chatContainer = document.getElementById('chat-container');
        const usernameInput = document.getElementById('username-input');
        const roomSelect = document.getElementById('room-select');
        const joinButton = document.getElementById('join-button');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const roomName = document.getElementById('room-name');
        const userCount = document.getElementById('user-count');
        const usersList = document.getElementById('users-list');
        const roomsList = document.getElementById('rooms-list');
        const typingIndicator = document.getElementById('typing-indicator');

        // Join chat
        joinButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const room = roomSelect.value;

            if (username) {
                currentUser = username;
                currentRoom = room;
                socket.emit('join', { username, room });
                loginContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
                roomName.textContent = room.charAt(0).toUpperCase() + room.slice(1);
            }
        });

        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                socket.emit('send-message', { text });
                messageInput.value = '';
                socket.emit('stop-typing');
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Typing indicator
        messageInput.addEventListener('input', () => {
            socket.emit('typing');

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop-typing');
            }, 1000);
        });

        // Receive messages
        socket.on('message', (message) => {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${message.type}`;

            if (message.userId === socket.id) {
                messageEl.classList.add('own');
            }

            if (message.type === 'system') {
                messageEl.textContent = message.text;
            } else {
                messageEl.innerHTML = `
                    <div class="username">${message.user}</div>
                    <div>${message.text}</div>
                    <div class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>
                `;
            }

            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // Room history
        socket.on('room-history', (messages) => {
            messagesDiv.innerHTML = '';
            messages.forEach(message => {
                socket.emit('message', message);
            });
        });

        // Users update
        socket.on('users-update', (data) => {
            userCount.textContent = `${data.count} user${data.count !== 1 ? 's' : ''}`;
            usersList.innerHTML = data.users.map(user =>
                `<div class="user-item">${user.username}</div>`
            ).join('');
        });

        // Rooms list
        socket.on('rooms-list', (rooms) => {
            roomsList.innerHTML = rooms.map(room =>
                `<div class="room-item ${room.name.toLowerCase() === currentRoom ? 'active' : ''}"
                      onclick="switchRoom('${room.name.toLowerCase()}')">
                    ${room.name} (${room.userCount})
                </div>`
            ).join('');
        });

        // Typing indicator
        let typingUsers = new Set();
        socket.on('user-typing', (data) => {
            typingUsers.add(data.username);
            updateTypingIndicator();
        });

        socket.on('user-stop-typing', (data) => {
            typingUsers.forEach(username => {
                // Remove after delay
                setTimeout(() => {
                    typingUsers.delete(username);
                    updateTypingIndicator();
                }, 500);
            });
        });

        function updateTypingIndicator() {
            if (typingUsers.size === 0) {
                typingIndicator.textContent = '';
            } else if (typingUsers.size === 1) {
                typingIndicator.textContent = `${[...typingUsers][0]} is typing...`;
            } else {
                typingIndicator.textContent = `Multiple people are typing...`;
            }
        }

        // Switch room
        function switchRoom(room) {
            currentRoom = room;
            socket.emit('switch-room', { room });
            roomName.textContent = room.charAt(0).toUpperCase() + room.slice(1);
        }
    </script>
</body>
</html>
